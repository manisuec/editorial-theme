{{/*
  Newsletter Form Partial
  Usage: {{ partial "newsletter-form.html" (dict "id" "unique-id" "context" . "dark" false) }}
  Params:
    - id: unique identifier for form elements (required)
    - context: the page context for accessing Site.Params
    - dark: boolean for dark theme styling (optional, default false)
*/}}
{{- $id := .id | default "newsletter" -}}
{{- $context := .context -}}
{{- $dark := .dark | default false -}}

{{- with $context.Site.Params.mailerlite }}
{{- if .enable }}
<form id="{{ $id }}-form" class="newsletter-form" role="form" aria-label="Newsletter subscription">
    <label for="{{ $id }}-email" class="visually-hidden">Email address</label>
    <input
        type="email"
        name="email"
        id="{{ $id }}-email"
        class="newsletter-input"
        placeholder="your@email.com"
        required
        autocomplete="email"
        aria-describedby="{{ $id }}-message"
    />
    <button type="submit" class="newsletter-btn" id="{{ $id }}-submit">
        Subscribe
    </button>
</form>
<p id="{{ $id }}-message" class="newsletter-message" role="status" aria-live="polite" style="display: none;"></p>
<script>
(function() {
    const form = document.getElementById('{{ $id }}-form');
    const emailInput = document.getElementById('{{ $id }}-email');
    const submitBtn = document.getElementById('{{ $id }}-submit');
    const messageEl = document.getElementById('{{ $id }}-message');
    const apiKey = '{{ .apiKey }}';
    const groupId = '{{ .groupId }}';

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = emailInput.value.trim();
        if (!email) return;

        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');
        submitBtn.textContent = 'Subscribing...';
        messageEl.style.display = 'none';

        try {
            const response = await fetch('https://connect.mailerlite.com/api/subscribers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + apiKey
                },
                body: JSON.stringify({
                    email: email,
                    groups: [groupId],
                    status: 'active'
                })
            });

            messageEl.style.display = 'block';

            if (response.ok || response.status === 200 || response.status === 201) {
                messageEl.textContent = 'Thanks for subscribing!';
                messageEl.className = 'newsletter-message success';
                emailInput.value = '';
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Subscription failed');
            }
        } catch (error) {
            messageEl.style.display = 'block';
            messageEl.textContent = error.message || 'Something went wrong. Please try again.';
            messageEl.className = 'newsletter-message error';
        } finally {
            submitBtn.disabled = false;
            submitBtn.removeAttribute('aria-busy');
            submitBtn.textContent = 'Subscribe';
        }
    });
})();
</script>
{{- end }}
{{- end }}

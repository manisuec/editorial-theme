{{ define "main" }}
<section class="hero">
    <div class="container">
        <div class="hero-content">
            <h1>
                {{ with .Site.Params.heroTitle }}{{ . }}{{ else }}Deep<br>Tech<br>Wisdom{{ end }}
            </h1>
            <p class="subtitle">{{ .Site.Params.heroSubtitle }}</p>
            
            <div class="hero-meta">
                {{ range .Site.Params.stats }}
                <div class="meta-item">
                    <span class="meta-label">{{ .label }}</span>
                    <span class="meta-value">{{ .value }}</span>
                </div>
                {{ end }}
                <a href="{{ "post" | relURL }}" class="hero-cta">Start Reading</a>
            </div>

            <div class="hero-actions-wrapper">
                <p class="newsletter-label">Stay in the loop for insights on backend development</p>
                {{- with .Site.Params.mailerlite }}
                {{- if .enable }}
                <form id="newsletter-form" class="newsletter-form">
                    <input type="email" name="email" id="newsletter-email" class="newsletter-input" placeholder="your@email.com" required autocomplete="email"/>
                    <button type="submit" class="newsletter-btn" id="newsletter-submit">Subscribe</button>
                </form>
                <p id="newsletter-message" class="newsletter-message" style="display: none;"></p>
                <script>
                (function() {
                    const form = document.getElementById('newsletter-form');
                    const emailInput = document.getElementById('newsletter-email');
                    const submitBtn = document.getElementById('newsletter-submit');
                    const messageEl = document.getElementById('newsletter-message');
                    const apiKey = '{{ .apiKey }}';
                    const groupId = '{{ .groupId }}';

                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();

                        const email = emailInput.value.trim();
                        if (!email) return;

                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Subscribing...';
                        messageEl.style.display = 'none';

                        try {
                            const response = await fetch('https://connect.mailerlite.com/api/subscribers', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + apiKey
                                },
                                body: JSON.stringify({
                                    email: email,
                                    groups: [groupId],
                                    status: 'active'
                                })
                            });

                            messageEl.style.display = 'block';

                            if (response.ok || response.status === 200 || response.status === 201) {
                                messageEl.textContent = 'Thanks for subscribing!';
                                messageEl.className = 'newsletter-message success';
                                emailInput.value = '';
                            } else {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Subscription failed');
                            }
                        } catch (error) {
                            messageEl.style.display = 'block';
                            messageEl.textContent = error.message || 'Something went wrong. Please try again.';
                            messageEl.className = 'newsletter-message error';
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Subscribe';
                        }
                    });
                })();
                </script>
                {{- else }}
                <form id="newsletter-form" class="newsletter-form" action="#" method="post">
                    <input name="email" class="newsletter-input" placeholder="your@email.com" required autocomplete="email"/>
                    <button type="submit" class="newsletter-btn">Subscribe</button>
                </form>
                {{- end }}
                {{- end }}
            </div>
        </div>

        <div class="hero-image">
            <div class="hero-image-text">{ }</div>
        </div>
    </div>
</section>

<section class="featured">
    <div class="container">
        <div class="section-label">Latest Insights</div>
        
        <div class="featured-grid">
            <div class="featured-sidebar">
                <h2>{{ with index (.Site.RegularPages.ByDate.Reverse) 0 }}{{ .Site.Params.featuredTitle | default "Node.js Security Done Right" }}{{ end }}</h2>
                <p>
                    {{ with index (.Site.RegularPages.ByDate.Reverse) 0 }}{{ .Site.Params.featuredDescription | default "Production lessons from someone who's learned the hard way. Real vulnerabilities, real solutions." }}{{ end }}
                </p>
            </div>

            <div class="featured-content">
                {{ range first 3 (.Site.RegularPages.ByDate.Reverse) }}
                <a href="{{ .Permalink }}" class="article-card">
                    <div class="article-header">
                        {{ with .Params.categories }}
                        <span class="article-tag">{{ index . 0 }}</span>
                        {{ end }}
                        <div class="share-icons-inline">
                            {{ partial "share-icons-inline.html" . }}
                        </div>
                    </div>
                    <h3>{{ .Title }}</h3>
                    <p class="article-excerpt">
                        {{ .Summary | truncate 150 }}
                    </p>
                    <div class="article-meta">
                        <span>{{ .Date.Format "Jan 2, 2006" }}</span>
                        <span class="read-time">{{ .ReadingTime }} min read</span>
                    </div>
                </a>
                {{ end }}
            </div>
        </div>
    </div>
</section>

<section class="topics">
    <div class="container">
        <h2>Explore Topics</h2>
        
        <div class="topics-grid">
            {{ $categoryItems := .Params.categories.items }}
            {{ $taxonomy := .Site.Taxonomies.categories }}
            {{ range $categoryItems }}
                {{ $title := .title }}
                {{ $url := .url }}
                {{ $thumbnail := .thumbnail }}
                {{ $description := .description }}
                {{ if (index $taxonomy $url) }}
                    {{ $page := (index $taxonomy $url).Page }}
                    <a href="{{ $page.Permalink }}" class="topic-card">
                        <img src="{{ $thumbnail }}" alt="{{ $page.Title }}" class="topic-thumbnail">
                        <div class="topic-name">{{ $page.Title }}</div>
                    </a>
                {{ else }}
                    <a href="{{ "/categories/" | relURL }}{{ $url }}" class="topic-card">
                        <img src="{{ $thumbnail }}" alt="{{ $title }}" class="topic-thumbnail">
                        <div class="topic-name">{{ $title }}</div>
                    </a>
                {{ end }}
            {{ end }}
        </div>
    </div>
</section>
{{ end }}
